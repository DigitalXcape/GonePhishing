@model IEnumerable<GonePhishing.Models.DomainTask>
@{
    var job = ViewData["Job"] as GonePhishing.Models.ScanJob;
    int total = (int)ViewData["Total"];
    int page = (int)ViewData["Page"];
    int pageSize = (int)ViewData["PageSize"];

    int totalPages = (int)Math.Ceiling(total / (double)pageSize);
}
<h2>Scan Status - Job @job.Id</h2>
<p>Created: @job.CreatedAt.ToLocalTime()</p>
<p>Seed domains:<pre>@job.SeedDomains</pre></p>
<p>Number of typo domains: @job.NumberOfTypoDomains</p>

<button id="refresh">Refresh</button>

<!-- Pagnation buttons -->
<div style="margin:10px 0;">
    <strong>Page @(page) of @totalPages</strong><br />

    @if (page > 1) {
        <a href="/Scan/Status?id=@job.Id&page=@(page - 1)&pageSize=@pageSize">Previous</a>
    }

    @if (page < totalPages) {
        <a href="/Scan/Status?id=@job.Id&page=@(page + 1)&pageSize=@pageSize">Next</a>
    }
</div>

<table border="1" id="results" cellpadding="4" style="border-collapse:collapse;">
    <thead style="text-align:left;">
        <tr>
            <th>Base Domain</th>
            <th>Domain</th>
            <th>State</th>
            <th>IPs</th>
            <th>HTTP</th>
            <th>error</th>
            <th>When</th>
        </tr>
    </thead>
    <tbody id="resultsBody">
        <!-- Start empty (code is old)-->
        
    </tbody>
</table>

<script>
    const page = @(page);
    const pageSize = @(pageSize);
    const jobId = @(job.Id);

    // Refresh button
    document.getElementById('refresh').addEventListener('click', () => fetchStatus());

    // Auto-refresh every 5s
    setInterval(fetchStatus, 5000);

    // Map LookUpStatus integer to background color
    function getStatusColor(status) {
        switch (status) {
            case 0: return "white";      // Unknown
            case 1: return "#f0f0f0";    // NoIP (gray)
            case 2: return "#cce5ff";    // OwnedByOrigin (blue)
            case 3: return "white";      // HtmlChecked (neutral)
            case 4: return "#ccffcc";    // Safe (green)
            case 5: return "#fff5cc";    // Suspicious (yellow)
            case 6: return "#ffcccc";    // Danger (red)
            case 7: return "#ffebcc";    // Error (peach)
            default: return "white";
        }
    }

    async function fetchStatus() {
        try {
            const r = await fetch(`/Scan/StatusJson?id=${jobId}&page=${page}&pageSize=${pageSize}`);
            const j = await r.json();
            const tbody = document.querySelector('#results tbody');
            tbody.innerHTML = '';

            for (const t of j.tasks) {
                const tr = document.createElement('tr');

                tr.style.backgroundColor = getStatusColor(t.lookUpStatus);

                tr.innerHTML = `
                        <td>${t.baseDomain ?? ''}</td>
                        <td>${t.candidateDomain ?? ''}</td>
                        <td>${t.state ?? ''}</td>
                        <td>${t.ipAddresses ?? ''}</td>
                        <td>${t.httpStatus ?? ''} ${t.httpReason ?? ''}</td>
                        <td>${t.error ?? ''}</td>
                        <td>${t.processedAt ?? ''}</td>
                    `;
                tbody.appendChild(tr);
            }
        } catch (ex) {
            console.error("Failed to fetch status:", ex);
        }
    }

    // Initial load
    fetchStatus();
</script>